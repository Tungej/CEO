{% extends "base.html" %}
{% block content %}
<div class="header">
    <div style="display: flex; align-items: center;">
        <img src="{{ url_for('static', filename='logo.png') }}" alt="Company Logo" class="header-logo">
        <div>
            <h1 style="margin: 0; line-height: 1;">Operations Dashboard</h1>
            <span style="color: var(--text-secondary); font-size: 0.9em;">{{ date.strftime('%A, %d %B %Y') }}</span>
        </div>
    </div>
    <div>
        <span class="status-badge">‚óè Live</span>
        <a href="{{ url_for('logout') }}" class="nav-link">Logout</a>
    </div>
</div>

<!-- ==========================
     SECTION 1: CASH & BANK (Top Row)
     ========================== -->
<div style="margin-top: 30px;">
    <div style="display: flex; align-items: baseline; margin-bottom: 25px; border-bottom: 1px solid #334155; padding-bottom: 10px;">
        <h2 style="margin: 0;">Daily Cash & Bank Position</h2>
    </div>

    <!-- THIS GRID IS ONLY FOR BANKS + PETTY CASH + TOTAL -->
    <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 50px;">
        
        <!-- 1. Banks Loop -->
        {% for bank in balances %}
        <div class="card">
            <h3 style="color: var(--text-secondary); margin-bottom: 15px;">{{ bank.name }}</h3>
            <div style="display: flex; justify-content: space-between; align-items: flex-end; border-bottom: 1px solid #334155; padding-bottom: 10px; margin-bottom: 10px;">
                <span style="font-size: 0.9em; color: var(--accent);">USD</span>
                <span style="font-size: 1.5em; font-weight: bold;">${{ "{:,.0f}".format(bank.usd) }}</span>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: flex-end;">
                <span style="font-size: 0.9em; color: #fbbf24;">ZiG</span>
                <span style="font-size: 1.5em; font-weight: bold; color: #fbbf24;">{{ bank.zig | format_k }}</span>
            </div>
        </div>
        {% endfor %}

        <!-- 2. Petty Cash -->
        <div class="card" style="border-left: 4px solid var(--accent);">
            <h3 style="color: var(--text-secondary); margin-bottom: 15px;">Petty Cash</h3>
            <div style="display: flex; justify-content: space-between; align-items: flex-end; border-bottom: 1px solid #334155; padding-bottom: 10px; margin-bottom: 10px;">
                <span style="font-size: 0.9em; color: var(--accent);">USD</span>
                <span style="font-size: 1.5em; font-weight: bold;">${{ "{:,.0f}".format(petty_usd) }}</span>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: flex-end;">
                <span style="font-size: 0.9em; color: #fbbf24;">ZiG</span>
                <span style="font-size: 1.5em; font-weight: bold; color: #fbbf24;">{{ petty_zig | format_k }}</span>
            </div>
        </div>

        <!-- 3. Total Company Cash -->
        <div class="card" style="background-color: #064e3b; border: 1px solid #10b981;">
            <h3 style="color: #a7f3d0; margin-bottom: 15px;">Total Company Cash</h3>
            <div style="display: flex; justify-content: space-between; align-items: flex-end; border-bottom: 1px solid #059669; padding-bottom: 10px; margin-bottom: 10px;">
                <span style="font-size: 0.9em; color: #fff;">USD</span>
                <span style="font-size: 1.8em; font-weight: bold; color: #fff;">${{ "{:,.0f}".format(total_usd) }}</span>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: flex-end;">
                <span style="font-size: 0.9em; color: #fcd34d;">ZiG</span>
                <span style="font-size: 1.8em; font-weight: bold; color: #fcd34d;">{{ total_zig | format_k }}</span>
            </div>
        </div>

    </div> <!-- CLOSING THE BANK GRID HERE IS CRITICAL -->
</div>


<!-- ==========================
     SECTION 2: FINANCIAL POSITION (Second Row)
     ========================== -->
<div style="margin-top: 30px;">
    <div style="display: flex; align-items: baseline; margin-bottom: 25px; border-bottom: 1px solid #334155; padding-bottom: 10px;">
        <h2 style="margin: 0;">Financial Position</h2>
        <span style="margin-left: 15px; color: var(--text-secondary); font-size: 0.9em;">Weekly / Monthly</span>
    </div>

    <!-- THIS IS A NEW GRID FOR FINANCIAL CARDS -->
    <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
        
        <!-- Interest Card -->
        <div class="card">
            <div style="display:flex; justify-content:space-between;">
                <h3>Monthly Bank Interest</h3>
                <span style="font-size: 1.2em;">üè¶</span>
            </div>
            <div class="big-number">${{ "{:,.0f}".format(interest.total) }}</div>
            <div class="sub-info">
                <span>Interest Paid</span>
                <span style="color: white;">${{ "{:,.0f}".format(interest.paid) }}</span>
            </div>
            <div class="sub-info" style="border:none; padding-top:5px; margin-top:0;">
                <span>Interest Due</span>
                <span style="color: white;">${{ "{:,.0f}".format(interest.due) }}</span>
            </div>
        </div>

        <!-- Payables Card -->
        <div class="card">
            <div style="display:flex; justify-content:space-between;">
                <h3>Weekly Account Payables</h3>
                <span style="font-size: 1.2em;">üìâ</span>
            </div>
            <div class="big-number">${{ "{:,.0f}".format(payables.total) }}</div>
            <div class="sub-info">
                <span>Creditors</span>
                <span style="color: white;">${{ "{:,.0f}".format(payables.creditors) }}</span>
            </div>
            <div class="sub-info" style="border:none; padding-top:5px; margin-top:0;">
                <span>Creditors Project</span>
                <span style="color: white;">${{ "{:,.0f}".format(payables.project) }}</span>
            </div>
        </div>

        <!-- Receivables Card -->
        <div class="card">
            <div style="display:flex; justify-content:space-between;">
                <h3>Weekly Account Receivables</h3>
                <span style="font-size: 1.2em;">üìà</span>
            </div>
            <div class="big-number">${{ "{:,.0f}".format(receivables.total) }}</div>
            <div class="sub-info">
                <span>Total Outstanding</span>
                <span style="color: white;">${{ "{:,.0f}".format(receivables.total) }}</span>
            </div>
        </div>

    </div>
</div>
<!-- ... Rest of Production / Sales KPIs ... -->

<!-- ==========================
     MAIN SECTION: PRODUCTION KPIs
     ========================== -->
<div style="margin-top: 50px;">
    <!-- Main Section Header -->
    <div style="display: flex; align-items: baseline; margin-bottom: 25px; border-bottom: 1px solid #334155; padding-bottom: 10px;">
        <h2 style="margin: 0;">Production KPIs</h2>
        <span style="margin-left: 15px; color: var(--text-secondary); font-size: 0.9em;">SMS & Rolling</span>
    </div>

    <!-- ROW 1 -->
    <div class="grid">
        <!-- SMS Tonnage -->
        <div class="card" style="border-left: 4px solid #f97316;"> <!-- Orange Accent -->
            <div style="display:flex; justify-content:space-between;">
                <h3 style="color: var(--text-secondary);">SMS Tonnage</h3>
                <span>üè≠</span>
            </div>
            <div class="big-number">
                {{ "{:,.3f}".format(prod_main.sms_tonnage) if prod_main else "0.000" }} 
                <span style="font-size:0.5em; color: var(--text-secondary);">Tns</span>
            </div>
        </div>

        <!-- Unit 1 Rolling -->
        <div class="card">
            <div style="display:flex; justify-content:space-between;">
                <h3 style="color: var(--text-secondary);">Unit 1 Rolling</h3>
                <span>‚öôÔ∏è</span>
            </div>
            <div class="big-number">
                {{ "{:,.3f}".format(prod_main.rolling_unit_1) if prod_main else "0.000" }} 
                <span style="font-size:0.5em; color: var(--text-secondary);">Tns</span>
            </div>
        </div>

        <!-- Unit 2 Rolling -->
        <div class="card">
            <div style="display:flex; justify-content:space-between;">
                <h3 style="color: var(--text-secondary);">Unit 2 Rolling</h3>
                <span>‚öôÔ∏è</span>
            </div>
            <div class="big-number">
                {{ "{:,.3f}".format(prod_main.rolling_unit_2) if prod_main else "0.000" }} 
                <span style="font-size:0.5em; color: var(--text-secondary);">Tns</span>
            </div>
        </div>
    </div>
</div>

    <!-- ROW 3: SPONGE IRON -->
    <h3 style="margin-top: 40px; color: var(--text-secondary);">Sponge Iron Production</h3>
    <div class="grid">
        <div class="card">
            <h3>Sponge Iron Produced</h3>
            <div class="big-number">
                {{ "{:,.3f}".format(prod_sponge.produced_tns) if prod_sponge else "0.000" }} 
                <span style="font-size:0.5em; color: var(--text-secondary);">Tns</span>
            </div>
        </div>
        <div class="card">
            <h3>Sponge Iron Lost</h3>
            <div class="big-number" style="color: #ef4444;"> <!-- Red color for loss -->
                {{ "{:,.3f}".format(prod_sponge.lost_tns) if prod_sponge else "0.000" }} 
                <span style="font-size:0.5em; color: var(--text-secondary);">Tns</span>
            </div>
        </div>
    </div>
</div>
<!-- ==========================
     MAIN SECTION: SALES KPIs
     ========================== -->
<div style="margin-top: 50px;">
    <div style="display: flex; align-items: baseline; margin-bottom: 25px; border-bottom: 1px solid #334155; padding-bottom: 10px;">
        <h2 style="margin: 0;">Sales KPIs</h2>
        <span style="margin-left: 15px; color: var(--text-secondary); font-size: 0.9em;">All Products & Branches</span>
    </div>

    <!-- ROW 1: NEW PRODUCT SALES -->
    <div class="grid" style="margin-bottom: 30px;">
        <!-- Angles -->
        <div class="card">
            <div style="display:flex; justify-content:space-between;">
                <h3 style="color: var(--text-secondary);">Angles</h3>
                <span>üì¶</span>
            </div>
            <div class="big-number">
                {{ "{:,.3f}".format(sales.angles_sales) if sales else "0.000" }} 
                <span style="font-size:0.5em; color: var(--text-secondary);">Tns</span>
            </div>
        </div>

        <!-- Flats -->
        <div class="card">
            <div style="display:flex; justify-content:space-between;">
                <h3 style="color: var(--text-secondary);">Flats</h3>
                <span>üì¶</span>
            </div>
            <div class="big-number">
                {{ "{:,.3f}".format(sales.flats_sales) if sales else "0.000" }} 
                <span style="font-size:0.5em; color: var(--text-secondary);">Tns</span>
            </div>
        </div>

        <!-- Window Sections -->
        <div class="card">
            <div style="display:flex; justify-content:space-between;">
                <h3 style="color: var(--text-secondary);">Window Sections</h3>
                <span>ü™ü</span>
            </div>
            <div class="big-number">
                {{ "{:,.3f}".format(sales.window_sections_sales) if sales else "0.000" }} 
                <span style="font-size:0.5em; color: var(--text-secondary);">Tns</span>
            </div>
        </div>

        <!-- Channel Iron -->
        <div class="card">
            <div style="display:flex; justify-content:space-between;">
                <h3 style="color: var(--text-secondary);">Channel Iron</h3>
                <span>üèóÔ∏è</span>
            </div>
            <div class="big-number">
                {{ "{:,.3f}".format(sales.channel_iron_sales) if sales else "0.000" }} 
                <span style="font-size:0.5em; color: var(--text-secondary);">Tns</span>
            </div>
        </div>
        <!-- Other Sections -->
        <div class="card">
            <div style="display:flex; justify-content:space-between;">
                <h3 style="color: var(--text-secondary);">Other Sections</h3>
                <span>üì¶</span>
            </div>
            <div class="big-number">
                {{ "{:,.3f}".format(sales.other_sections_sales) if sales else "0.000" }} 
                <span style="font-size:0.5em; color: var(--text-secondary);">Tns</span>
            </div>
        </div>
    </div>

    <!-- ROW 2: SALES BY BRANCH -->
    <h3 style="color: var(--text-secondary); font-size: 1em; margin-bottom: 15px;">üìç Sales by Branch</h3>
    <div class="grid">
        <!-- Redcliff -->
        <div class="card">
            <h3 style="color: var(--text-secondary);">Redcliff</h3>
            <div class="big-number">
                {{ "{:,.2f}".format(sales.redcliff_sales) if sales else "0.00" }} 
                <span style="font-size:0.5em; color: var(--text-secondary);">Tns</span>
            </div>
        </div>

        <!-- Harare -->
        <div class="card">
            <h3 style="color: var(--text-secondary);">Harare</h3>
            <div class="big-number">
                {{ "{:,.2f}".format(sales.harare_sales) if sales else "0.00" }} 
                <span style="font-size:0.5em; color: var(--text-secondary);">Tns</span>
            </div>
        </div>

        <!-- Mutare -->
        <div class="card">
            <h3 style="color: var(--text-secondary);">Mutare</h3>
            <div class="big-number">
                {{ "{:,.2f}".format(sales.mutare_sales) if sales else "0.00" }} 
                <span style="font-size:0.5em; color: var(--text-secondary);">Tns</span>
            </div>
        </div>

        <div class="card">
            <h3 style="color: var(--text-secondary);">Chiredzi</h3>
            <div class="big-number">
                {{ "{:,.2f}".format(sales.chiredzi_sales) if sales else "0.00" }} 
                <span style="font-size:0.5em; color: var(--text-secondary);">Tns</span>
            </div>
        </div>

        <!-- Bulawayo -->
        <div class="card">
            <h3 style="color: var(--text-secondary);">Bulawayo</h3>
            <div class="big-number">
                {{ "{:,.2f}".format(sales.bulawayo_sales) if sales else "0.00" }} 
                <span style="font-size:0.5em; color: var(--text-secondary);">Tns</span>
            </div>
        </div>
    </div>
</div>
<!-- ==========================
     GAS PLANT KPIs (Consolidated)
     ========================== -->
<div style="margin-top: 50px;">
    <div style="display: flex; align-items: baseline; margin-bottom: 25px; border-bottom: 1px solid #334155; padding-bottom: 10px;">
        <h2 style="margin: 0;">Gas Plant KPIs</h2>
    </div>

    <div class="grid">
        <!-- Industrial Gases -->
        <div class="card">
            <div style="display:flex; justify-content:space-between;">
                <h3 style="color: var(--text-secondary);">Industrial Gases</h3>
                <span>üí®</span>
            </div>
            <div class="big-number">
                {{ "{:,.0f}".format(gas.industrial_gases_cyl) if gas else "0" }} 
                <span style="font-size:0.5em; color: var(--text-secondary);">Cylinders</span>
            </div>
        </div>
    </div>
</div>

<!-- ==========================
     MAIN SECTION: SCRAP PURCHASE KPIs
     ========================== -->
<div style="margin-top: 50px;">
    <div style="display: flex; align-items: baseline; margin-bottom: 25px; border-bottom: 1px solid #334155; padding-bottom: 10px;">
        <h2 style="margin: 0;">Scrap Purchase KPIs</h2>
        <span style="margin-left: 15px; color: var(--text-secondary); font-size: 0.9em;">Raw Materials</span>
    </div>

    <div class="grid">
        <!-- Supplied Scrap -->
        <div class="card">
            <div style="display:flex; justify-content:space-between;">
                <h3 style="color: var(--text-secondary);">Supplied Scrap</h3>
                <span>üöõ</span>
            </div>
            <div class="big-number">
                {{ "{:,.3f}".format(scrap.supplied_tns) if scrap else "0.000" }} 
                <span style="font-size:0.5em; color: var(--text-secondary);">Tns</span>
            </div>
        </div>

        <!-- Total Purchased -->
        <div class="card">
            <div style="display:flex; justify-content:space-between;">
                <h3 style="color: var(--text-secondary);">Total Scrap Purchased</h3>
                <span>‚ôªÔ∏è</span>
            </div>
            <div class="big-number">
                {{ "{:,.3f}".format(scrap.total_purchased_tns) if scrap else "0.000" }} 
                <span style="font-size:0.5em; color: var(--text-secondary);">Tns</span>
            </div>
        </div>
    </div>
</div>

<!-- ==========================
     MAIN SECTION: OPERATIONAL KPIs
     ========================== -->
<div style="margin-top: 50px;">
    <div style="display: flex; align-items: baseline; margin-bottom: 25px; border-bottom: 1px solid #334155; padding-bottom: 10px;">
        <h2 style="margin: 0;">Operational KPIs</h2>
        <span style="margin-left: 15px; color: var(--text-secondary); font-size: 0.9em;">Power & Downtime</span>
    </div>

    <div class="grid">
        <!-- Power Cut Unit I -->
        <div class="card">
            <div style="display:flex; justify-content:space-between;">
                <h3 style="color: var(--text-secondary);">Power Cut ‚Äì Unit I</h3>
                <span>‚ö°</span>
            </div>
            <div class="big-number">
                {{ ops.u1_hours if ops else 0 }}<span style="font-size:0.7em">h</span> 
                {{ ops.u1_minutes if ops else 0 }}<span style="font-size:0.7em">m</span>
            </div>
            <div class="sub-info">
                <span>Cumulative downtime</span>
            </div>
        </div>

        <!-- Power Cut Unit II -->
        <div class="card">
            <div style="display:flex; justify-content:space-between;">
                <h3 style="color: var(--text-secondary);">Power Cut ‚Äì Unit II</h3>
                <span>‚ö°</span>
            </div>
            <div class="big-number">
                {{ ops.u2_hours if ops else 0 }}<span style="font-size:0.7em">h</span> 
                {{ ops.u2_minutes if ops else 0 }}<span style="font-size:0.7em">m</span>
            </div>
            <div class="sub-info">
                <span>Cumulative downtime</span>
            </div>
        </div>
    </div>
</div>
<a href="{{ url_for('dashboard') }}" class="refresh-fab" id="refreshBtn">
    <span>‚Üª</span> Refresh Data
</a>

<!-- 3. JAVASCRIPT FOR SCROLL BEHAVIOR -->
<script>
    let isScrolling;
    const refreshBtn = document.getElementById('refreshBtn');

    window.addEventListener('scroll', function ( event ) {
        // Clear the timeout while scrolling
        window.clearTimeout( isScrolling );

        // Add the hidden class (Make it disappear)
        refreshBtn.classList.add('is-hidden');

        // Set a timeout to run after scrolling ends (e.g., 200ms)
        isScrolling = setTimeout(function() {
            // Remove the hidden class (Make it appear)
            refreshBtn.classList.remove('is-hidden');
        }, 200);

    }, false);
</script>
{% endblock %}